@page "/crafting"
@using RogueStarIdle.ServerApplication.Shared.State;
@inject TimeState timeState;
@inject InventoryState inventoryState;
@inject ActionState actionState;
@inject IItemUseCases GetItemByIdUseCase

<div class="page-content-container" style="display: flex; align-items: flex-start;">
    <div class="column" style="width: 100%;">
        <h3>CRAFTING</h3>
        <div class="row" style="width: 100%; height: 100%;">
            <div style="display:flex; flex-direction:column; align-items: flex-start; width: 25%">
                <button @onclick='() => SelectRecipeList(scrapRecipes)' class="selection-button">Scrap</button>
                <button @onclick='() => SelectRecipeList(weaponRecipes)' class ="selection-button">Weapons</button>
                <button @onclick='() => SelectRecipeList(armorRecipes)' class="selection-button">Armor</button>
                <button @onclick='() => SelectRecipeList(constructionRecipes)' class="selection-button">Building Materials</button>
                <button @onclick='() => SelectRecipeList(aidRecipes)' class="selection-button">Aid</button>
                <button @onclick='() => SelectRecipeList(huntingRecipes)' class="selection-button">Hunting</button>
            </div>
            <div style="display:flex; flex-direction:column; align-items: flex-start; width: 25%">
                @foreach (CraftingRecipe recipe in selectedRecipeList)
                {
                    <button @onclick='() => SelectRecipe(recipe)' class="selection-button">@recipe.Item.Name</button>
                }
            </div>
            <div style="display: flex; flex-direction: column; align-items: center; width: 50%">
                @if (actionState.selectedRecipe.Item.Name != "")
                {
                    <h2>@actionState.selectedRecipe.Item.Name</h2>
                    <img src=@actionState.selectedRecipe.Item.Thumbnail style="width: 25%; border: solid black  2px" />
                    <p>Requires:</p>
                    @foreach((Item item, int qty) in actionState.selectedRecipe.Ingredients) {
                        Item inventoryItem = inventoryState.Inventory.FirstOrDefault(i => i.Id == item.Id) ?? new Item();
                        int inventoryQuantity = inventoryItem.Quantity;
                        <p>@qty.ToString() x @item.Name (@inventoryQuantity)</p>
                    }
                    @if (!actionState.IsCrafting)
                    {
                        <button @onclick="() => actionState.EnterCrafting()">Craft</button>
                    }
                    @if (actionState.IsCrafting)
                    {
                        <LoadBarComponent amountComplete=(actionState.TicksBetweenAction-actionState.TicksUntilAction) total=actionState.TicksBetweenAction color="blue" />
                        <button @onclick="() => actionState.LeaveCrafting()">Stop</button>
                    }
                }
            </div>      
        </div>
    </div>
</div>

@code {
    public List<CraftingRecipe> selectedRecipeList = new List<CraftingRecipe>();
    public List<CraftingRecipe> scrapRecipes = new List<CraftingRecipe>();
    public List<CraftingRecipe> weaponRecipes = new List<CraftingRecipe>();
    public List<CraftingRecipe> armorRecipes = new List<CraftingRecipe>();
    public List<CraftingRecipe> aidRecipes = new List<CraftingRecipe>();
    public List<CraftingRecipe> constructionRecipes = new List<CraftingRecipe>();
    public List<CraftingRecipe> huntingRecipes = new List<CraftingRecipe>();

    async Task UpdateState()
    {
        await InvokeAsync(StateHasChanged);
    }

    public void SelectRecipeList(List<CraftingRecipe> recipeList)
    {
        selectedRecipeList = recipeList;
    }

    public void SelectRecipe(CraftingRecipe recipe)
    {
        if (actionState.IsCrafting)
        {
            actionState.LeaveCrafting();
        }
        actionState.selectedRecipe = recipe;
    }

    protected override async Task OnInitializedAsync()
    {
        inventoryState.OnChange += UpdateState;
        actionState.OnChange += UpdateState;
        scrapRecipes = new List<CraftingRecipe>()
        {

        };
        constructionRecipes = new List<CraftingRecipe>()
        {

        };
        aidRecipes = new List<CraftingRecipe>()
        {
            new CraftingRecipe()
                {
                    Item = await GetItemByIdUseCase.ExecuteAsync(18), // Cloth Bandage
                    Ingredients = new List<(Item, int)>
                {
                    (await GetItemByIdUseCase.ExecuteAsync(16), 2), // Plant Fiber
                },
                    RequiredSkillLevels = new List<(string, int)>()
                {
                    ("Survival", 1)
                },
                    XpReward = ("Survival", 1),
                    Unlocked = true
                }        
        };
        armorRecipes = new List<CraftingRecipe>()
        {
            new CraftingRecipe()
                {
                    Item = await GetItemByIdUseCase.ExecuteAsync(5), // Tardihop Fur Hat
                    Ingredients = new List<(Item, int)>
                {
                    (await GetItemByIdUseCase.ExecuteAsync(15), 2), // Tardihop Fur
                    (await GetItemByIdUseCase.ExecuteAsync(16), 2) // Plant Fiber
                },
                    RequiredSkillLevels = new List<(string, int)>()
                {
                    ("Armor Crafting", 1)
                },
                    XpReward = ("Armor Crafting", 1),
                    Unlocked = true
                },
            new CraftingRecipe()
                {
                    Item = await GetItemByIdUseCase.ExecuteAsync(6), // Tardihop Fur Gloves
                    Ingredients = new List<(Item, int)>
                {
                    (await GetItemByIdUseCase.ExecuteAsync(15), 2), // Tardihop Fur
                    (await GetItemByIdUseCase.ExecuteAsync(16), 2) // Plant Fiber
                },
                    RequiredSkillLevels = new List<(string, int)>()
                {
                    ("Armor Crafting", 1)
                },
                    XpReward = ("Armor Crafting", 1),
                    Unlocked = true
                },
            new CraftingRecipe()
                {
                    Item = await GetItemByIdUseCase.ExecuteAsync(7), // Tardihop Fur Shirt
                    Ingredients = new List<(Item, int)>
                {
                    (await GetItemByIdUseCase.ExecuteAsync(15), 5), // Tardihop Fur
                    (await GetItemByIdUseCase.ExecuteAsync(16), 10) // Plant Fiber
                },
                    RequiredSkillLevels = new List<(string, int)>()
                {
                    ("Armor Crafting", 1)
                },
                    XpReward = ("Armor Crafting", 1),
                    Unlocked = true
                },
            new CraftingRecipe()
                {
                    Item = await GetItemByIdUseCase.ExecuteAsync(8), // Tardihop Fur Pants
                    Ingredients = new List<(Item, int)>
                {
                    (await GetItemByIdUseCase.ExecuteAsync(15), 5), // Tardihop Fur
                    (await GetItemByIdUseCase.ExecuteAsync(16), 10) // Plant Fiber
                },
                    RequiredSkillLevels = new List<(string, int)>()
                {
                    ("Armor Crafting", 1)
                },
                    XpReward = ("Armor Crafting", 1),
                    Unlocked = true
                },
            new CraftingRecipe()
                {
                    Item = await GetItemByIdUseCase.ExecuteAsync(9), // Tardihop Fur Hat
                    Ingredients = new List<(Item, int)>
                {
                    (await GetItemByIdUseCase.ExecuteAsync(15), 2), // Tardihop Fur
                    (await GetItemByIdUseCase.ExecuteAsync(16), 3) // Plant Fiber
                },
                    RequiredSkillLevels = new List<(string, int)>()
                {
                    ("Armor Crafting", 1)
                },
                    XpReward = ("Armor Crafting", 1),
                    Unlocked = true
                }
        };
        weaponRecipes = new List<CraftingRecipe>()
        {
            new CraftingRecipe()
                {
                    Item = await GetItemByIdUseCase.ExecuteAsync(4), // Bone Knife
                    Ingredients = new List<(Item, int)>
                {
                    (await GetItemByIdUseCase.ExecuteAsync(2), 1), // Small bones
                    (await GetItemByIdUseCase.ExecuteAsync(16), 2) // Plant Fiber
                },
                    RequiredSkillLevels = new List<(string, int)>()
                {
                    ("Weapon Crafting", 1)
                },
                    XpReward = ("Weapon Crafting", 1),
                    Unlocked = true
                }
        };
        huntingRecipes = new List<CraftingRecipe>()
        {
            new CraftingRecipe()
                {
                    Item = await GetItemByIdUseCase.ExecuteAsync(17), // Tardihop Bait
                    Ingredients = new List<(Item, int)>
                {
                    (await GetItemByIdUseCase.ExecuteAsync(10), 1), // Azurali Grass
                },
                    RequiredSkillLevels = new List<(string, int)>()
                {
                    ("Survival", 1)
                },
                    XpReward = ("Survival", 1),
                    Unlocked = true
                }
        };
    }
}
